<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de usuario - Tecoche</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="DIWLogo.png" type="image/x-icon">
</head>
<body>
    <a href="#main-content" class="skip-link">Saltar al contenido principal</a>
    <header id="header" role="banner">
        <div class="container header-content">
            <a href="index.html#inicio" class="logo" aria-label="Ir a la página de inicio">
                <img src="DIWLogo.png" alt="Tecoche - Taller de confianza en Manises" class="logo-img">
            </a>
            <nav id="nav-menu" class="nav-menu" role="navigation" aria-label="Navegación principal">
                <a href="index.html#inicio" data-target="inicio" aria-label="Ir a la sección de inicio">Inicio</a>
                <a href="index.html#servicios" data-target="servicios" aria-label="Ver nuestros servicios">Servicios</a>
                <a href="compra-venta.html" aria-label="Ver coches en venta">Coches</a>
                <a href="tienda.html" aria-label="Ir a la tienda de repuestos">Tienda</a>
                <a href="index.html#galeria" data-target="galeria" aria-label="Ver galería de trabajos">Galería</a>
                <a href="index.html#contacto" data-target="contacto" aria-label="Formulario de contacto">Contacto</a>
                <a href="calculadora-presupuesto.html" aria-label="Calculadora de presupuesto PHP">Presupuesto PHP</a>
                <a href="carrito.html" class="cart-icon-btn" aria-label="Ver carrito de compra"
                    style="position: relative;">
                    <i class="fa-solid fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-badge"
                        style="display:none; position: absolute; top: -8px; right: -8px; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7em;">0</span>
                </a>
            </nav>
            <div id="auth-controls" style="display: flex; align-items: center; gap: 10px;">
                <a href="perfil.html" id="user-profile-btn" class="login-icon-btn active" aria-label="Área de usuario">
                    <i class="fa-solid fa-user"></i>
                </a>
                <button id="header-logout-btn" class="cta-button secondary-cta"
                    style="display: none; padding: 5px 10px; font-size: 0.8em;" aria-label="Cerrar sesión">
                    <i class="fa-solid fa-sign-out-alt"></i>
                </button>
            </div>
            <a href="tel:679426134" class="cta-button primary-cta" aria-label="Llamar ahora al teléfono 679 426 134">
                <i class="fa-solid fa-phone" aria-hidden="true"></i> Llamar ahora
            </a>
            <button class="hamburger" id="hamburger-menu" aria-label="Abrir menú de navegación" aria-expanded="false"
                aria-controls="nav-menu">
                <svg class="hamburger-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                    aria-hidden="true">
                    <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" />
                </svg>
            </button>
        </div>
    </header>
    <script src="script.js" type="module" defer></script>
    <main id="main-content" class="section-padding bg-light" style="min-height: 80vh;">
        <div class="container">
            <div class="profile-card">
                <div class="profile-header">
                    <div class="profile-info">
                        <div class="profile-avatar">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="profile-details">
                            <h1 id="user-name">Cargando...</h1>
                            <p id="user-email">...</p>
                            <span id="user-role" class="role-badge">Cargando rol...</span>
                        </div>
                    </div>
                    <div class="profile-actions" style="display: flex; gap: 10px;">
                        <button id="edit-profile-btn" class="cta-button secondary-cta">
                            <i class="fa-solid fa-pen"></i> Editar Perfil
                        </button>
                        <button id="logout-btn" class="cta-button secondary-cta"
                            style="background: #e74c3c; color: white; border: none;">
                            <i class="fa-solid fa-sign-out-alt"></i> Cerrar sesión
                        </button>
                    </div>
                </div>
                <div id="verification-warning"
                    style="display: none; background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ffeeba;">
                    <div
                        style="display: flex; align-items: center; gap: 10px; justify-content: space-between; flex-wrap: wrap;">
                        <div>
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <strong>Tu correo electrónico no está verificado.</strong>
                            <p style="margin: 5px 0 0; font-size: 0.9em;">Verifícalo para asegurar el acceso a tu
                                cuenta.</p>
                        </div>
                        <button id="resend-verification-btn" class="cta-button secondary-cta"
                            style="font-size: 0.8em; padding: 5px 10px; background: transparent; border-color: #856404; color: #856404;">
                            Reenviar correo
                        </button>
                    </div>
                </div>
                <div class="user-dashboard-content">
                    <h2 style="color: var(--color-primary); margin-bottom: 20px;">Mi historial de pedidos</h2>
                    <div id="loading-orders">Cargando pedidos...</div>
                    <div id="orders-list" style="display: flex; flex-direction: column; gap: 15px;">
                    </div>
                </div>
                <div id="admin-panel-link"
                    style="display: none; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h3 style="margin-bottom: 10px;">Zona de administración</h3>
                    <a href="admin.html" class="cta-button primary-cta">Ir al panel de administración</a>
                </div>
            </div>
        </div>
        <div id="edit-profile-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>Editar Perfil</h2>
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-nombre">Nombre</label>
                        <input type="text" id="edit-nombre" required>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="edit-avatar">URL de Foto de Perfil (Opcional)</label>
                        <input type="url" id="edit-avatar" placeholder="https://ejemplo.com/mifoto.jpg">
                    </div>
                    <button type="submit" class="cta-button primary-cta full-width"
                        style="margin-top: 20px; width: 100%;">
                        Guardar cambios
                    </button>
                </form>
            </div>
        </div>
    </main>
    <footer id="footer" role="contentinfo">
        <div class="container footer-grid">
            <div class="footer-col footer-about">
                <a href="index.html#inicio" class="logo-footer" aria-label="Ir al inicio de la página">
                    <img src="DIWLogo.png" alt="Logo de Tecoche - Taller de confianza" class="logo-img">
                </a>
                <p>Tecoche es tu taller de confianza en Manises, Valencia, con más de 20 años de experiencia en
                    reparación, tuning y compra-venta de vehículos. Venta y reparación con confianza.</p>
                <div class="social-icons" role="navigation" aria-label="Redes sociales">
                    <a href="https://www.facebook.com" target="_blank" rel="noopener noreferrer"
                        aria-label="Visitar Facebook"><i class="fa-brands fa-facebook-f" aria-hidden="true"></i></a>
                    <a href="https://www.instagram.com" target="_blank" rel="noopener noreferrer"
                        aria-label="Visitar Instagram"><i class="fa-brands fa-instagram" aria-hidden="true"></i></a>
                    <a href="https://www.linkedin.com" target="_blank" rel="noopener noreferrer"
                        aria-label="Visitar LinkedIn"><i class="fa-brands fa-linkedin-in" aria-hidden="true"></i></a>
                </div>
            </div>
            <nav class="footer-col" aria-labelledby="footer-links-title">
                <h3 id="footer-links-title" class="footer-title">Enlaces rápidos</h3>
                <ul class="footer-links">
                    <li><a href="index.html#inicio" aria-label="Ir a la sección de inicio">Inicio</a></li>
                    <li><a href="index.html#servicios" aria-label="Ir a la sección de servicios">Servicios</a></li>
                    <li><a href="index.html#galeria" aria-label="Ir a la galería de trabajos">Galería de trabajos</a>
                    </li>
                    <li><a href="index.html#contacto" aria-label="Ir al formulario de contacto">Contacto y
                            presupuesto</a></li>
                    <li><a href="aviso-legal.html" aria-label="Aviso legal">Aviso legal</a></li>
                    <li><a href="politica-privacidad.html" aria-label="Política de privacidad">Política de
                            privacidad</a></li>
                    <li><a href="politica-cookies.html" aria-label="Política de cookies">Política de cookies</a></li>
                    <li><a href="mapa-sitio.html" aria-label="Mapa del sitio">Mapa del sitio</a></li>
                    <li><a href="calculadora-presupuesto.html" style="color: #ff9f1c; font-weight: bold;"><i
                                class="fa-brands fa-php"></i> Calculadora PHP</a></li>
                </ul>
            </nav>
            <div class="footer-col">
                <h3 class="footer-title">Nuestros servicios</h3>
                <ul class="footer-links" aria-label="Lista de servicios ofrecidos">
                    <li>Reparación y mantenimiento</li>
                    <li>Tuning y personalización</li>
                    <li>Compra-venta de vehículos</li>
                    <li>Servicio de grúa 24 horas</li>
                    <li>Tienda de repuestos</li>
                </ul>
            </div>
            <div class="footer-col">
                <h3 class="footer-title">Información de contacto</h3>
                <address class="footer-contact-info">
                    <p><i class="fa-solid fa-location-dot" aria-hidden="true"></i> Calle del Automóvil, 123, 46940
                        Manises, Valencia</p>
                    <p><i class="fa-solid fa-phone-volume" aria-hidden="true"></i> <a href="tel:963947804"
                            aria-label="Llamar al 96 394 78 04"> 96 394 78 04</a></p>
                    <p><i class="fa-solid fa-mobile-screen" aria-hidden="true"></i> <a href="tel:679426134"
                            aria-label="Llamar al móvil 679 426 134"> 679 426 134 (Móvil)</a></p>
                    <p><i class="fa-solid fa-envelope" aria-hidden="true"></i> <a href="mailto:admtecoche@gmail.com"
                            aria-label="Enviar email a admtecoche@gmail.com"> admtecoche@gmail.com</a></p>
                    <p><i class="fa-regular fa-clock" aria-hidden="true"></i> <span
                            aria-label="Horario: Lunes a viernes 7:30 a 19:00, Sábados 9:00 a 15:00"> L-V: 07:30-19:00 |
                            S: 09:00-15:00</span></p>
                </address>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Tecoche. Todos los derechos reservados. | Desarrollado con HTML, CSS y JS.</p>
        </div>
    </footer>
    <script type="module">
        import { auth, db } from "./js/firebase-config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        // Check Auth State
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is logged in
                document.getElementById('user-email').textContent = user.email;
                // Check verification
                if (!user.emailVerified) {
                    const warningDiv = document.getElementById('verification-warning');
                    const resendBtn = document.getElementById('resend-verification-btn');
                    if (warningDiv) {
                        warningDiv.style.display = 'block';
                        if (resendBtn) {
                            resendBtn.addEventListener('click', async () => {
                                const originalText = resendBtn.textContent;
                                resendBtn.disabled = true;
                                resendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
                                try {
                                    // Dynamic import of resend function to avoid circular dep issues in module if any
                                    const { resendVerificationEmail } = await import("./js/auth.js");
                                    await resendVerificationEmail(user);
                                    resendBtn.textContent = '¡Enviado!';
                                    resendBtn.style.borderColor = 'green';
                                    resendBtn.style.color = 'green';
                                } catch (error) {
                                    console.error("Error resending email:", error);
                                    resendBtn.textContent = 'Error. Intenta más tarde.';
                                    resendBtn.style.color = 'red';
                                } finally {
                                    setTimeout(() => {
                                        resendBtn.disabled = false;
                                        if (resendBtn.textContent === '¡Enviado!') {
                                            resendBtn.textContent = 'Reenviar de nuevo';
                                            resendBtn.style.color = '#856404';
                                            resendBtn.style.borderColor = '#856404';
                                        }
                                    }, 5000);
                                }
                            });
                        }
                    }
                }
                try {
                    const docRef = doc(db, "usuarios", user.uid);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('user-name').textContent = data.nombre || "Usuario";
                        document.getElementById('edit-nombre').value = data.nombre || "";
                        document.getElementById('edit-avatar').value = data.avatarURL || "";
                        // Actualizar Avatar si existe
                        if (data.avatarURL) {
                            const avatarContainer = document.querySelector('.profile-avatar');
                            avatarContainer.innerHTML = `<img src="${data.avatarURL}" alt="Foto de perfil" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                        }
                        const role = data.rol || 'cliente';
                        const roleElement = document.getElementById('user-role');
                        if (role === 'admin') {
                            roleElement.textContent = 'Administrador';
                            roleElement.className = 'role-badge role-admin';
                            document.getElementById('admin-panel-link').style.display = 'block';
                        } else {
                            roleElement.textContent = 'Cliente';
                            roleElement.className = 'role-badge role-cliente';
                        }
                    } else {
                        document.getElementById('user-name').textContent = "Usuario (Sin perfil)";
                        document.getElementById('user-role').textContent = 'Cliente';
                        document.getElementById('user-role').className = 'role-badge role-cliente';
                    }
                    // Load Orders
                    loadOrders(user.uid);
                } catch (e) {
                    console.error("Error fetching user profile:", e);
                    document.getElementById('user-name').textContent = "Error al cargar perfil";
                    document.getElementById('loading-orders').textContent = "Error al cargar historial.";
                }
            } else {
                // No user is signed in, redirect to login
                window.location.href = 'login.html';
            }
        });
        // Function to load orders
        async function loadOrders(userId) {
            // Import dynamically to avoid top-level await issues if any, 
            // or assume they are available if imported at top (which they are not in this block). 
            // Since this is a module script, we can import at top level, but let's fix the scope first.
            // Actually, dynamic imports are cleaner inside function if we don't want to touch top of file.
            const { collection, query, where, getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const container = document.getElementById('orders-list');
            const loading = document.getElementById('loading-orders');
            // ... implementation ...
            try {
                const q = query(
                    collection(db, "pedidos"),
                    where("userId", "==", userId)
                );
                const querySnapshot = await getDocs(q);
                loading.style.display = 'none';
                if (querySnapshot.empty) {
                    container.innerHTML = '<p>No has realizado ningún pedido todavía.</p>';
                    return;
                }
                const orders = [];
                querySnapshot.forEach(doc => {
                    orders.push({ id: doc.id, ...doc.data() });
                });
                orders.sort((a, b) => {
                    const dateA = a.fecha && a.fecha.seconds ? new Date(a.fecha.seconds * 1000) : new Date(0);
                    const dateB = b.fecha && b.fecha.seconds ? new Date(b.fecha.seconds * 1000) : new Date(0);
                    return dateB - dateA;
                });
                orders.forEach(order => {
                    const date = order.fecha && order.fecha.seconds ? new Date(order.fecha.seconds * 1000).toLocaleDateString() : 'Fecha desc.';
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    let itemsHtml = '<ul style="margin: 10px 0; padding-left: 20px;">';
                    if (order.items && Array.isArray(order.items)) {
                        order.items.forEach(item => {
                            itemsHtml += `<li>${item.quantity}x ${item.nombre} - ${(item.precio).toFixed(2)}€</li>`;
                        });
                    }
                    itemsHtml += '</ul>';
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; font-size:1.1em; color:var(--color-primary);">Pedido #${order.id.slice(0, 8)}</h3>
                            <span style="font-size:0.9em; color:#666;">${date}</span>
                        </div>
                        ${itemsHtml}
                        <div style="display:flex; justify-content:space-between; margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                            <span style="font-weight:bold; color:green;">${order.estado ? order.estado.toUpperCase() : 'PAGADO'}</span>
                            <span style="font-weight:bold; font-size:1.2em;">Total: ${order.total.toFixed(2)} €</span>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Orders Error:", error);
                loading.textContent = "No se pudieron cargar los pedidos.";
            }
        }
        // Modal Edit Logic
        const editModal = document.getElementById('edit-profile-modal');
        const editBtn = document.getElementById('edit-profile-btn');
        const closeEditModal = editModal.querySelector('.close-modal');
        const editForm = document.getElementById('edit-profile-form');
        editBtn.addEventListener('click', () => {
            editModal.style.display = 'block';
        });
        closeEditModal.addEventListener('click', () => {
            editModal.style.display = 'none';
        });
        window.addEventListener('click', (e) => {
            if (e.target === editModal) editModal.style.display = 'none';
        });
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            const nuevoNombre = document.getElementById('edit-nombre').value;
            const nuevaAvatarURL = document.getElementById('edit-avatar').value;
            try {
                await updateDoc(doc(db, "usuarios", user.uid), {
                    nombre: nuevoNombre,
                    avatarURL: nuevaAvatarURL
                });
                alert("Perfil actualizado correctamente.");
                window.location.reload();
            } catch (error) {
                console.error("Error updating profile:", error);
                alert("Error al actualizar perfil.");
            }
        });
        // Logout logic
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });
    </script>
    <script type="module" src="js/verification-guard.js"></script>
    <script type="module" src="js/header-logic.js"></script>
</body>
</html>
